#!/bin/bash
# SessionEnd Hook - Update memories after coach sessions and track learnings

# Read input from Claude
INPUT=$(cat)
TRANSCRIPT_PATH=$(echo "$INPUT" | jq -r '.transcript_path')
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id')
CWD=$(echo "$INPUT" | jq -r '.cwd')

# Expand tilde in transcript path
TRANSCRIPT_PATH="${TRANSCRIPT_PATH/#\~/$HOME}"

# Check if /coach was invoked
COACH_USED=$(grep -c '"name":"SlashCommand".*"command":"/coach"' "$TRANSCRIPT_PATH" 2>/dev/null || echo 0)
# Ensure it's a single number
COACH_USED=$(echo "$COACH_USED" | tr -d '\n' | head -c 10)

if [ "$COACH_USED" -gt 0 ]; then
    # Coach session detected - update coach.md memory bank
    (
        PROMPT="Read session transcript at $TRANSCRIPT_PATH and update MEMORY BANK in ~/.claude/commands/coach.md with:

## PART 1: Session Analysis Tasks
1. Current trajectory assessment (Reorientation/Paralysis/Momentum/etc.)
2. Active patterns observed (Cathedral Building, Permission Problem, Local Maximum Trap)
3. Somatic signals noted (throat tightness triggers, body vs head language)
4. Commitments made during session
5. Outcomes of previous commitments (if mentioned)
6. Add session log entry with:
   - Date: $(date +%Y-%m-%d)
   - Mode used (Partner/Coach/Catalyst/Profound Experience)
   - Tools deployed (Truth Gate, Parts Work, Agreement Ladder, etc.)
   - Key insights and breakthroughs
7. Update 'Last updated' timestamp to $(date +%Y-%m-%d)

## PART 2: Memory Management (Auto-Summarization)
After updating the session:

1. Count session entries in the Session Log section
2. If there are MORE than 15 session entries:
   a. Extract the oldest 5-10 sessions (keep the most recent 10 detailed)
   b. Analyze them to identify:
      - Recurring patterns across those sessions
      - Major trajectory shifts
      - Key commitments and their outcomes
      - Persistent themes or struggles
      - Notable breakthroughs
   c. Create a condensed Historical Summary entry like:

      ### Historical Summary

      **Sessions 001-010 (YYYY-MM-DD to YYYY-MM-DD):**
      - Overall Trajectory: [Summary of trajectory evolution over this period]
      - Key Patterns Observed: [Cathedral Building frequency, Permission Problem manifestations, etc.]
      - Major Commitments: [List significant commitments and whether completed]
      - Breakthrough Moments: [Any significant insights or shifts]
      - Mode Distribution: Partner: X, Coach: Y, Catalyst: Z

   d. Insert this Historical Summary section between Pattern Evolution and Session Log
   e. Remove the detailed entries for the oldest sessions, keeping only recent 10
   f. Update Session Log header to reflect new range (e.g., 'Session Log (Last 10 Sessions)')

3. If 15 or fewer sessions, skip summarization

Preserve essential insights - be concise but don't lose critical long-term patterns.
Only edit the MEMORY BANK section. Preserve all other content in coach.md."

        echo "$PROMPT" | claude --print --allowed-tools "Read Edit(~/.claude/commands/coach.md)" \
            > /tmp/coach-memory-update-$SESSION_ID.log 2>&1

        # Play subtle completion sound
        afplay "/System/Library/PrivateFrameworks/ToneLibrary.framework/Versions/A/Resources/AlertTones/EncoreInfinitum/Portal-EncoreInfinitum.caf"
    ) &

    echo "Coach session detected - triggering memory update in background (PID: $!)"
else
    # Regular session - extract learnings for future improvement
    (
        PROMPT="Read session transcript at $TRANSCRIPT_PATH and analyze what could be improved for future sessions.

## PART 1: Analysis Tasks
1. Identify any mistakes, errors, or misunderstandings
2. Note patterns that worked well
3. Extract any user corrections or feedback
4. Identify missing knowledge or capabilities
5. Note any repeated questions or confusion

If there are meaningful learnings, append them to a 'Session Learnings (Auto-captured)' section in ~/.claude/CLAUDE.md:

**$(date +%Y-%m-%d) - Session $SESSION_ID:**
- [Key learnings here]

Only add if there are actual learnings worth preserving. If session was routine with no issues, skip to Part 2.

## PART 2: Memory Management (Auto-Summarization)
After updating learnings:

1. Count entries in the 'Session Learnings (Auto-captured)' section
2. If there are MORE than 20 learning entries:
   a. Extract the oldest 10 entries
   b. Analyze them to identify:
      - Common recurring mistakes or patterns
      - Successfully learned behaviors that no longer appear
      - Key user preferences discovered
      - Critical capabilities added
   c. Create a condensed summary like:

      ### Historical Learnings Summary

      **Sessions from YYYY-MM-DD to YYYY-MM-DD (Entries 1-10):**
      - Common mistakes resolved: [List patterns that were fixed]
      - Key preferences learned: [User preferences now integrated]
      - Capabilities added: [New skills or knowledge acquired]
      - Persistent gaps: [Things still needing improvement]

   d. Insert this Historical Learnings Summary at the top of the section
   e. Remove the oldest 10 detailed entries, keeping only recent 20
   f. Update section header if needed

3. If 20 or fewer entries, skip summarization

Preserve important learnings - be concise but don't lose critical improvements."

        echo "$PROMPT" | claude --print --allowed-tools "Read Edit(~/.claude/CLAUDE.md)" \
            > /tmp/session-learnings-$SESSION_ID.log 2>&1

        # Play subtle completion sound
        afplay "/System/Library/PrivateFrameworks/ToneLibrary.framework/Versions/A/Resources/AlertTones/EncoreInfinitum/Portal-EncoreInfinitum.caf"
    ) &

    echo "Regular session - analyzing for learnings in background (PID: $!)"
fi

# Exit successfully
exit 0
