#!/bin/bash
# SessionEnd Hook - Update memories after coach sessions and track learnings

# Read input from Claude
INPUT=$(cat)
TRANSCRIPT_PATH=$(echo "$INPUT" | jq -r '.transcript_path')
SESSION_ID=$(echo "$INPUT" | jq -r '.session_id')
CWD=$(echo "$INPUT" | jq -r '.cwd')

# Expand tilde in transcript path
TRANSCRIPT_PATH="${TRANSCRIPT_PATH/#\~/$HOME}"

# Check if /coach was invoked
COACH_USED=$(grep -c '"name":"SlashCommand".*"command":"/coach"' "$TRANSCRIPT_PATH" 2>/dev/null || echo "0")

if [ "$COACH_USED" -gt 0 ]; then
    # Coach session detected - update coach.md memory bank
    nohup claude --print \
        --allowed-tools "Read Edit(~/.claude/commands/coach.md)" \
        "Read session transcript at $TRANSCRIPT_PATH and update MEMORY BANK in ~/.claude/commands/coach.md with:

## PART 1: Session Analysis Tasks
1. Current trajectory assessment (Reorientation/Paralysis/Momentum/etc.)
2. Active patterns observed (Cathedral Building, Permission Problem, Local Maximum Trap)
3. Somatic signals noted (throat tightness triggers, body vs head language)
4. Commitments made during session
5. Outcomes of previous commitments (if mentioned)
6. Add session log entry with:
   - Date: $(date +%Y-%m-%d)
   - Mode used (Partner/Coach/Catalyst/Profound Experience)
   - Tools deployed (Truth Gate, Parts Work, Agreement Ladder, etc.)
   - Key insights and breakthroughs
7. Update 'Last updated' timestamp to $(date +%Y-%m-%d)

## PART 2: Memory Management (Auto-Summarization)
After updating the session:

1. Count session entries in the Session Log section
2. If there are MORE than 15 session entries:
   a. Extract the oldest 5-10 sessions (keep the most recent 10 detailed)
   b. Analyze them to identify:
      - Recurring patterns across those sessions
      - Major trajectory shifts
      - Key commitments and their outcomes
      - Persistent themes or struggles
      - Notable breakthroughs
   c. Create a condensed Historical Summary entry like:

      ### Historical Summary

      **Sessions 001-010 (YYYY-MM-DD to YYYY-MM-DD):**
      - Overall Trajectory: [Summary of trajectory evolution over this period]
      - Key Patterns Observed: [Cathedral Building frequency, Permission Problem manifestations, etc.]
      - Major Commitments: [List significant commitments and whether completed]
      - Breakthrough Moments: [Any significant insights or shifts]
      - Mode Distribution: Partner: X, Coach: Y, Catalyst: Z

   d. Insert this Historical Summary section between Pattern Evolution and Session Log
   e. Remove the detailed entries for the oldest sessions, keeping only recent 10
   f. Update Session Log header to reflect new range (e.g., 'Session Log (Last 10 Sessions)')

3. If 15 or fewer sessions, skip summarization

Preserve essential insights - be concise but don't lose critical long-term patterns.
Only edit the MEMORY BANK section. Preserve all other content in coach.md." \
        > /tmp/coach-memory-update-$SESSION_ID.log 2>&1 &

    echo "Coach session detected - triggering memory update in background (PID: $!)"
else
    # Regular session - extract learnings for future improvement
    nohup claude --print \
        --allowed-tools "Read Edit(~/.claude/CLAUDE.md)" \
        "Read session transcript at $TRANSCRIPT_PATH and analyze what could be improved for future sessions.

## Analysis Tasks:
1. Identify any mistakes, errors, or misunderstandings
2. Note patterns that worked well
3. Extract any user corrections or feedback
4. Identify missing knowledge or capabilities
5. Note any repeated questions or confusion

If there are meaningful learnings, append them to a 'Session Learnings' section in ~/.claude/CLAUDE.md under a new heading:

### Session Learnings (Auto-captured)

**$(date +%Y-%m-%d) - Session $SESSION_ID:**
- [Key learnings here]

Only add if there are actual learnings worth preserving. If session was routine with no issues, output 'No significant learnings' and don't modify CLAUDE.md." \
        > /tmp/session-learnings-$SESSION_ID.log 2>&1 &

    echo "Regular session - analyzing for learnings in background (PID: $!)"
fi

# Exit successfully
exit 0
