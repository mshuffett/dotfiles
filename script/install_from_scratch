#!/bin/bash
# ============================================================================
# One-Line Bootstrap Installer
# ============================================================================
# This script can be run directly from GitHub:
# curl -fsSL https://raw.githubusercontent.com/mshuffett/dotfiles/fresh-mac-magic/script/install_and_run_wizard | bash

set -e

echo "ðŸš€ Dotfiles Bootstrap"
echo "====================="
echo ""

# Detect OS
IS_MACOS=0
IS_LINUX=0
if [[ "$OSTYPE" == "darwin"* ]]; then
  IS_MACOS=1
  echo "ðŸ“ Detected: macOS"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
  IS_LINUX=1
  echo "ðŸ“ Detected: Linux"
else
  echo "âŒ This script is designed for macOS or Linux"
  exit 1
fi

# Install build tools if needed
if [[ $IS_MACOS -eq 1 ]]; then
  if ! xcode-select -p &> /dev/null; then
    echo "ðŸ“¦ Installing Xcode Command Line Tools..."
    xcode-select --install
    echo "â³ Please complete the Xcode CLT installation in the dialog,"
    echo "   then re-run this script."
    exit 0
  fi
else
  # Linux: check for gcc
  if ! command -v gcc &> /dev/null; then
    echo "ðŸ“¦ Installing build-essential..."
    if command -v apt-get &> /dev/null; then
      sudo apt-get update && sudo apt-get install -y build-essential curl git
    elif command -v dnf &> /dev/null; then
      sudo dnf groupinstall -y "Development Tools" && sudo dnf install -y curl git
    fi
  fi
fi

# Install Homebrew if needed
if ! command -v brew &> /dev/null; then
  echo "ðŸº Installing Homebrew..."
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # Add Homebrew to PATH
  if [[ $IS_MACOS -eq 1 ]]; then
    if [[ $(uname -m) == "arm64" ]]; then
      echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
      eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
  else
    # Linux
    if [[ -d /home/linuxbrew/.linuxbrew ]]; then
      eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    fi
  fi
fi

# Clone dotfiles if not already present
if [[ ! -d "$HOME/.dotfiles" ]]; then
  echo "ðŸ“‚ Cloning dotfiles repository..."
  git clone https://github.com/mshuffett/dotfiles.git "$HOME/.dotfiles"
  cd "$HOME/.dotfiles"
  git checkout fresh-mac-magic
else
  echo "âœ“ Dotfiles already cloned"
  cd "$HOME/.dotfiles"

  # Offer to update
  echo "Update to latest version? (y/n)"
  read -r response
  if [[ "$response" =~ ^[Yy]$ ]]; then
    git pull origin fresh-mac-magic
  fi
fi

# Run the bootstrap wizard
echo ""
echo "ðŸŽ¨ Launching Bootstrap Wizard..."
echo ""
exec "$HOME/.dotfiles/script/bootstrap_wizard"
