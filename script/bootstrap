#!/bin/bash
set -e

# ============================================================================
# Fresh Mac Bootstrap Wizard
# ============================================================================
# Interactive setup script for configuring a new Mac with dotfiles
# Uses gum for a pleasant CLI experience

DOTFILES_DIR="$HOME/.dotfiles"

# Handle Ctrl+C gracefully
trap 'echo ""; log_warning "Bootstrap cancelled by user"; exit 130' INT TERM

# Colors for fallback (if gum isn't installed yet)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================================================
# Utility Functions
# ============================================================================

log_info() {
  if command -v gum &> /dev/null; then
    gum style --foreground 212 "âœ“ $1"
  else
    echo -e "${GREEN}âœ“${NC} $1"
  fi
}

log_error() {
  if command -v gum &> /dev/null; then
    gum style --foreground 196 "âœ— $1"
  else
    echo -e "${RED}âœ—${NC} $1"
  fi
}

log_warning() {
  if command -v gum &> /dev/null; then
    gum style --foreground 214 "âš  $1"
  else
    echo -e "${YELLOW}âš ${NC} $1"
  fi
}

show_header() {
  clear
  if command -v gum &> /dev/null; then
    gum style \
      --border double \
      --padding "1 2" \
      --margin "1" \
      --border-foreground 212 \
      "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" \
      "â•‘  â–‘â–ˆâ–€â–„â–‘â–ˆâ–€â–ˆâ–‘â–€â–ˆâ–€â–‘â–ˆâ–€â–€â–‘â–€â–ˆâ–€â–‘â–ˆâ–‘â–‘â–‘â–ˆâ–€â–€â–‘â–ˆâ–€â–€       â•‘" \
      "â•‘  â–‘â–ˆâ–‘â–ˆâ–‘â–ˆâ–‘â–ˆâ–‘â–‘â–ˆâ–‘â–‘â–ˆâ–€â–€â–‘â–‘â–ˆâ–‘â–‘â–ˆâ–‘â–‘â–‘â–ˆâ–€â–€â–‘â–€â–€â–ˆ       â•‘" \
      "â•‘  â–‘â–€â–€â–‘â–‘â–€â–€â–€â–‘â–‘â–€â–‘â–‘â–€â–‘â–‘â–‘â–€â–€â–€â–‘â–€â–€â–€â–‘â–€â–€â–€â–‘â–€â–€â–€       â•‘" \
      "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    echo ""
    gum style --foreground 212 --bold "Fresh Mac Bootstrap Wizard"
    echo ""

    gum style \
      --foreground 246 \
      "This interactive wizard will help you set up your Mac with:" \
      "" \
      "  ğŸ”§  Git configuration (name, email)" \
      "  ğŸ”—  Dotfile symlinks (zsh, tmux, git, etc.)" \
      "  ğŸ“¦  Homebrew packages (44 curated tools)" \
      "  âš™ï¸   Optional setup (Node.js, tmux plugins, Neovim)" \
      "" \
      "All steps are:" \
      "  âœ“ Safe (non-destructive backups)" \
      "  âœ“ Interactive (you choose what to install)" \
      "  âœ“ Idempotent (safe to run multiple times)"

    echo ""
  else
    cat << "EOF"

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  â–‘â–ˆâ–€â–„â–‘â–ˆâ–€â–ˆâ–‘â–€â–ˆâ–€â–‘â–ˆâ–€â–€â–‘â–€â–ˆâ–€â–‘â–ˆâ–‘â–‘â–‘â–ˆâ–€â–€â–‘â–ˆâ–€â–€       â•‘
â•‘  â–‘â–ˆâ–‘â–ˆâ–‘â–ˆâ–‘â–ˆâ–‘â–‘â–ˆâ–‘â–‘â–ˆâ–€â–€â–‘â–‘â–ˆâ–‘â–‘â–ˆâ–‘â–‘â–‘â–ˆâ–€â–€â–‘â–€â–€â–ˆ       â•‘
â•‘  â–‘â–€â–€â–‘â–‘â–€â–€â–€â–‘â–‘â–€â–‘â–‘â–€â–‘â–‘â–‘â–€â–€â–€â–‘â–€â–€â–€â–‘â–€â–€â–€â–‘â–€â–€â–€       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Fresh Mac Bootstrap Wizard

This interactive wizard will help you set up your Mac with:
  ğŸ”§  Git configuration (name, email)
  ğŸ”—  Dotfile symlinks (zsh, tmux, git, etc.)
  ğŸ“¦  Homebrew packages (44 curated tools)
  âš™ï¸   Optional setup (Node.js, tmux plugins, Neovim)

All steps are:
  âœ“ Safe (non-destructive backups)
  âœ“ Interactive (you choose what to install)
  âœ“ Idempotent (safe to run multiple times)

EOF
  fi
}

# ============================================================================
# Pre-flight Checks
# ============================================================================

check_os() {
  if [[ "$OSTYPE" != "darwin"* ]]; then
    log_error "This script is designed for macOS"
    exit 1
  fi
  log_info "Running on macOS"
}

check_xcode() {
  if ! xcode-select -p &> /dev/null; then
    log_warning "Xcode Command Line Tools not found"
    if command -v gum &> /dev/null; then
      choice=$(gum choose "Yes" "No" --header "Install Xcode Command Line Tools?")
      if [[ "$choice" == "Yes" ]]; then
        xcode-select --install
        log_info "Please complete the Xcode CLT installation, then re-run this script"
        exit 0
      else
        log_error "Xcode Command Line Tools required"
        exit 1
      fi
    else
      echo "Install Xcode Command Line Tools? (y/n)"
      read -r response
      if [[ "$response" =~ ^[Yy]$ ]]; then
        xcode-select --install
        log_info "Please complete the Xcode CLT installation, then re-run this script"
        exit 0
      else
        log_error "Xcode Command Line Tools required"
        exit 1
      fi
    fi
  else
    log_info "Xcode Command Line Tools installed"
  fi
}

install_homebrew() {
  if ! command -v brew &> /dev/null; then
    log_warning "Homebrew not found"
    if command -v gum &> /dev/null; then
      choice=$(gum choose "Yes" "No" --header "Install Homebrew?")
      if [[ "$choice" == "Yes" ]]; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

        # Add Homebrew to PATH for Apple Silicon Macs
        if [[ $(uname -m) == "arm64" ]]; then
          echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
          eval "$(/opt/homebrew/bin/brew shellenv)"
        fi

        log_info "Homebrew installed"
      else
        log_error "Homebrew is required"
        exit 1
      fi
    else
      echo "Install Homebrew? (y/n)"
      read -r response
      if [[ "$response" =~ ^[Yy]$ ]]; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

        # Add Homebrew to PATH for Apple Silicon Macs
        if [[ $(uname -m) == "arm64" ]]; then
          echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
          eval "$(/opt/homebrew/bin/brew shellenv)"
        fi

        log_info "Homebrew installed"
      else
        log_error "Homebrew is required"
        exit 1
      fi
    fi
  else
    log_info "Homebrew installed"
  fi
}

install_gum() {
  if ! command -v gum &> /dev/null; then
    log_info "Installing gum for better UI..."
    if brew install gum; then
      # Reload shell environment to pick up new binary
      if [[ $(uname -m) == "arm64" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
      fi

      # Verify gum is now available
      if command -v gum &> /dev/null; then
        log_info "gum installed successfully"
      else
        log_error "gum installation completed but command not found"
        echo "Please run the script again: ~/.dotfiles/script/bootstrap"
        exit 1
      fi
    else
      log_error "Failed to install gum"
      exit 1
    fi
  else
    log_info "gum already installed"
  fi
}

# ============================================================================
# Git Configuration
# ============================================================================

setup_git_config() {
  local name email existing_name existing_email

  gum style --foreground 212 "Git Configuration"

  # Get existing git config values if they exist
  existing_name=$(git config --global user.name 2>/dev/null || echo "")
  existing_email=$(git config --global user.email 2>/dev/null || echo "")

  # Use existing values as placeholders, or defaults if not set
  if [[ -n "$existing_name" ]]; then
    name=$(gum input --placeholder "$existing_name" --prompt "Name: " --value "$existing_name")
  else
    name=$(gum input --placeholder "Your full name" --prompt "Name: ")
  fi

  if [[ -n "$existing_email" ]]; then
    email=$(gum input --placeholder "$existing_email" --prompt "Email: " --value "$existing_email")
  else
    email=$(gum input --placeholder "your.email@example.com" --prompt "Email: ")
  fi

  if [[ -z "$name" ]] || [[ -z "$email" ]]; then
    log_error "Git name and email are required"
    exit 1
  fi

  # Create gitconfig from template
  if [[ -f "$DOTFILES_DIR/git/gitconfig.symlink.example" ]]; then
    cp "$DOTFILES_DIR/git/gitconfig.symlink.example" "$DOTFILES_DIR/git/gitconfig.symlink"
    sed -i '' "s/AUTHORNAME/$name/g" "$DOTFILES_DIR/git/gitconfig.symlink"
    sed -i '' "s/AUTHOREMAIL/$email/g" "$DOTFILES_DIR/git/gitconfig.symlink"
    sed -i '' "s/GIT_CREDENTIAL_HELPER/osxkeychain/g" "$DOTFILES_DIR/git/gitconfig.symlink"
    log_info "Git configured for $name <$email>"
  fi
}

# ============================================================================
# Symlink Creation
# ============================================================================

backup_file() {
  local file=$1
  local backup_strategy=$2  # "timestamped" or "suffix"

  if [[ ! -f "$file" ]] || [[ -L "$file" ]]; then
    return 0  # File doesn't exist or is already a symlink
  fi

  if [[ "$backup_strategy" == "timestamped" ]]; then
    # Use timestamped backup directory (best for bulk operations)
    local backup_dir="$HOME/.dotfiles_backup_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$backup_dir"
    cp "$file" "$backup_dir/$(basename "$file")"
    log_info "Backed up $(basename "$file") to $backup_dir"
    echo "$backup_dir"  # Return backup dir for summary
  else
    # Use .backup suffix (matches existing bootstrap script behavior)
    local backup_file="${file}.backup"

    # Never overwrite existing .backup files
    if [[ -f "$backup_file" ]]; then
      # Find next available number: .backup.1, .backup.2, etc.
      local counter=1
      while [[ -f "${backup_file}.${counter}" ]]; do
        ((counter++))
      done
      backup_file="${backup_file}.${counter}"
    fi

    mv "$file" "$backup_file"
    log_info "Backed up $(basename "$file") to $(basename "$backup_file")"
  fi
}

backup_existing_configs() {
  # First, check what files would be backed up
  local files_to_backup=()

  while IFS= read -r src; do
    local dst="$HOME/.$(basename "${src%.symlink}")"
    if [[ -f "$dst" ]] && [[ ! -L "$dst" ]]; then
      files_to_backup+=("$(basename "$dst")")
    fi
  done < <(find "$DOTFILES_DIR" -name "*.symlink" -not -path "*.git*")

  # If there are files to backup, show what will happen
  if [[ ${#files_to_backup[@]} -gt 0 ]]; then
    local backup_dir="$HOME/.dotfiles_backup_$(date +%Y%m%d_%H%M%S)"

    gum style \
      --foreground 214 \
      --border normal \
      --padding "1 2" \
      --margin "1" \
      "ğŸ“¦ Backup Plan" \
      "" \
      "The following files will be backed up to:" \
      "$backup_dir" \
      "" \
      "Files to backup:" \
      "$(printf '  â€¢ %s\n' "${files_to_backup[@]}")" \
      "" \
      "Your original files are SAFE - just copied to backup location."

    echo ""

    # Now actually backup
    mkdir -p "$backup_dir"

    for file in "${files_to_backup[@]}"; do
      cp "$HOME/$file" "$backup_dir/$file"
      log_info "Backed up $file â†’ $backup_dir/"
    done

    gum style --foreground 212 "âœ“ Backed up ${#files_to_backup[@]} files"
  else
    log_info "No existing configs to backup"
  fi
}

create_symlinks() {
  log_info "Creating symlinks..."

  # Find all .symlink files and create symlinks
  find "$DOTFILES_DIR" -name "*.symlink" -not -path "*.git*" | while read -r src; do
    dst="$HOME/.$(basename "${src%.symlink}")"

    # Remove existing symlink or file (already backed up)
    if [[ -L "$dst" ]]; then
      rm "$dst"
    elif [[ -f "$dst" ]]; then
      # File was already backed up in backup_existing_configs()
      rm "$dst"
    fi

    ln -s "$src" "$dst"
    log_info "Linked $(basename "$dst")"
  done
}

# ============================================================================
# Package Installation
# ============================================================================

install_packages() {
  gum style --foreground 212 "Package Installation"

  # Show what's in each category
  gum style \
    --foreground 246 \
    "Select which package categories to install:" \
    "" \
    "ğŸŸ¢ Essential (26 packages):" \
    "   git, gh, lazygit, tmux, fzf, neovim, bat, eza, fd," \
    "   ripgrep, zoxide, gum, glow, 1password-cli, gnupg..." \
    "" \
    "ğŸŸ¡ Development (4 packages):" \
    "   fnm (Node version manager), git-delta, flyctl, supabase" \
    "" \
    "ğŸŸ  Utilities (8 packages):" \
    "   gnu-sed, grep, moreutils, broot, chafa, duti, rclone" \
    "" \
    "ğŸ”µ Optional (6 packages):" \
    "   Nerd Fonts (FiraCode, JetBrains Mono, Hack, etc.)"

  echo ""

  # Ask which categories to install
  local categories
  categories=$(gum choose --no-limit \
    "ğŸŸ¢ Essential (26 packages)" \
    "ğŸŸ¡ Development (4 packages)" \
    "ğŸŸ  Utilities (8 packages)" \
    "ğŸ”µ Optional (6 packages)")

  if [[ -z "$categories" ]]; then
    log_warning "No packages selected, skipping installation"
    return
  fi

  # Show what will be installed
  local total_count=0
  echo ""
  gum style --foreground 214 --bold "ğŸ“¦ Packages to Install"
  echo ""

  if echo "$categories" | grep -q "Essential"; then
    gum style --foreground 212 "ğŸŸ¢ Essential:"
    sed -n '/^# ğŸŸ¢ ESSENTIAL/,/^# =/p' "$DOTFILES_DIR/Brewfile" | grep '^brew "' | sed 's/brew "//;s/".*//;s/^/  â€¢ /'
    echo ""
    ((total_count+=26))
  fi
  if echo "$categories" | grep -q "Development"; then
    gum style --foreground 214 "ğŸŸ¡ Development:"
    sed -n '/^# ğŸŸ¡ DEVELOPMENT/,/^# =/p' "$DOTFILES_DIR/Brewfile" | grep '^brew "' | sed 's/brew "//;s/".*//;s/^/  â€¢ /'
    echo ""
    ((total_count+=4))
  fi
  if echo "$categories" | grep -q "Utilities"; then
    gum style --foreground 208 "ğŸŸ  Utilities:"
    sed -n '/^# ğŸŸ  UTILITIES/,/^# =/p' "$DOTFILES_DIR/Brewfile" | grep '^brew "' | sed 's/brew "//;s/".*//;s/^/  â€¢ /'
    echo ""
    ((total_count+=8))
  fi
  if echo "$categories" | grep -q "Optional"; then
    gum style --foreground 33 "ğŸ”µ Optional (Nerd Fonts):"
    sed -n '/^# ğŸ”µ OPTIONAL/,/^$/p' "$DOTFILES_DIR/Brewfile" | grep '^cask "' | sed 's/cask "//;s/".*//;s/^/  â€¢ /'
    echo ""
    ((total_count+=6))
  fi

  gum style --foreground 212 "Total: $total_count packages"
  echo ""

  choice=$(gum choose "Yes, install" "No, skip" --header "Proceed with installation?")
  if [[ "$choice" == "No, skip" ]]; then
    log_warning "Package installation cancelled"
    return
  fi

  # Create temporary Brewfile with selected categories
  local temp_brewfile="/tmp/Brewfile.bootstrap"
  echo "# Temporary Brewfile for bootstrap" > "$temp_brewfile"
  echo "" >> "$temp_brewfile"

  # Always include taps
  grep "^tap " "$DOTFILES_DIR/Brewfile" >> "$temp_brewfile"
  echo "" >> "$temp_brewfile"

  # Add selected categories
  if echo "$categories" | grep -q "Essential"; then
    sed -n '/^# ğŸŸ¢ ESSENTIAL/,/^# =/p' "$DOTFILES_DIR/Brewfile" | grep -v "^# =" >> "$temp_brewfile"
  fi

  if echo "$categories" | grep -q "Development"; then
    sed -n '/^# ğŸŸ¡ DEVELOPMENT/,/^# =/p' "$DOTFILES_DIR/Brewfile" | grep -v "^# =" >> "$temp_brewfile"
  fi

  if echo "$categories" | grep -q "Utilities"; then
    sed -n '/^# ğŸŸ  UTILITIES/,/^# =/p' "$DOTFILES_DIR/Brewfile" | grep -v "^# =" >> "$temp_brewfile"
  fi

  if echo "$categories" | grep -q "Optional"; then
    sed -n '/^# ğŸ”µ OPTIONAL/,/^$/p' "$DOTFILES_DIR/Brewfile" >> "$temp_brewfile"
  fi

  # Install packages
  echo ""
  gum style --foreground 212 "Installing packages..."

  if brew bundle install --file="$temp_brewfile" 2>&1 | tee /tmp/brew-install.log; then
    rm "$temp_brewfile"
    log_info "Packages installed successfully"
  else
    log_error "Package installation failed!"
    echo ""
    echo "Error output:"
    tail -20 /tmp/brew-install.log
    echo ""
    log_error "Installation stopped. Please fix the errors above and re-run bootstrap."
    exit 1
  fi
}

# ============================================================================
# Additional Setup
# ============================================================================

setup_node() {
  local install_node=$1

  if [[ "$install_node" == "true" ]]; then
    if command -v fnm &> /dev/null; then
      if command -v node &> /dev/null; then
        log_info "Node.js already installed: $(node --version)"
      else
        echo ""
        gum style --foreground 212 "Installing Node.js LTS..."

        if fnm install --lts && fnm default lts-latest; then
          log_info "Node.js LTS installed and set as default"
        else
          log_error "Node.js installation failed"
          exit 1
        fi
      fi
    else
      log_warning "fnm not installed, skipping Node.js setup"
    fi
  fi
}

setup_tmux_plugins() {
  local install_tpm=$1

  if [[ "$install_tpm" == "true" ]]; then
    if [[ ! -d "$HOME/.tmux/plugins/tpm" ]]; then
      echo ""
      gum style --foreground 212 "Installing TPM and plugins..."

      if git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins; then
        log_info "TPM and plugins installed!"
      else
        log_error "TPM installation failed"
        exit 1
      fi
    else
      log_info "TPM already installed"
    fi
  fi
}

# ============================================================================
# Main Flow
# ============================================================================

main() {
  show_header

  # Pre-flight checks
  check_os
  check_xcode
  install_homebrew
  install_gum

  echo "" # Add spacing for readability

  # Check if we have an interactive terminal
  if [ ! -t 0 ]; then
    log_error "This script requires an interactive terminal"
    echo ""
    echo "Please run it directly from your terminal:"
    echo "  ~/.dotfiles/script/bootstrap"
    echo ""
    echo "Don't pipe it or run through other commands"
    exit 1
  fi

  # Confirm before proceeding
  echo ""
  gum style --foreground 212 "Ready to configure your setup?"
  ready=$(gum choose "Yes, let's go!" "No, cancel")

  if [[ "$ready" == "No, cancel" ]]; then
    log_info "Bootstrap cancelled"
    exit 0
  fi

  echo ""
  gum style --foreground 212 --bold "ğŸ“‹ Configuration"
  echo ""

  # ============================================================================
  # COLLECT ALL CHOICES UPFRONT
  # ============================================================================

  # Git configuration
  local git_name git_email existing_name existing_email
  if [[ ! -f "$DOTFILES_DIR/git/gitconfig.symlink" ]]; then
    gum style --foreground 246 "Git Configuration"
    existing_name=$(git config --global user.name 2>/dev/null || echo "")
    existing_email=$(git config --global user.email 2>/dev/null || echo "")

    if [[ -n "$existing_name" ]]; then
      git_name=$(gum input --placeholder "$existing_name" --prompt "Name: " --value "$existing_name")
    else
      git_name=$(gum input --placeholder "Your full name" --prompt "Name: ")
    fi

    if [[ -n "$existing_email" ]]; then
      git_email=$(gum input --placeholder "$existing_email" --prompt "Email: " --value "$existing_email")
    else
      git_email=$(gum input --placeholder "your.email@example.com" --prompt "Email: ")
    fi

    if [[ -z "$git_name" ]] || [[ -z "$git_email" ]]; then
      log_error "Git name and email are required"
      exit 1
    fi
    echo ""
  fi

  # Symlinks
  local create_symlinks_choice
  choice=$(gum choose "Yes" "No" --header "Create dotfile symlinks (.zshrc, .tmux.conf, .gitconfig, etc.)?")
  if [[ "$choice" == "Yes" ]]; then
    create_symlinks_choice="true"
  else
    create_symlinks_choice="false"
  fi
  echo ""

  # Package categories
  local package_categories
  if gum confirm "Install Homebrew packages?"; then
    gum style \
      --foreground 246 \
      "Select which package categories to install:" \
      "" \
      "ğŸŸ¢ Essential (26 packages):" \
      "   git, gh, lazygit, tmux, fzf, neovim, bat, eza, fd," \
      "   ripgrep, zoxide, gum, glow, 1password-cli, gnupg..." \
      "" \
      "ğŸŸ¡ Development (4 packages):" \
      "   fnm (Node version manager), git-delta, flyctl, supabase" \
      "" \
      "ğŸŸ  Utilities (8 packages):" \
      "   gnu-sed, grep, moreutils, broot, chafa, duti, rclone" \
      "" \
      "ğŸ”µ Optional (6 packages):" \
      "   Nerd Fonts (FiraCode, JetBrains Mono, Hack, etc.)"

    echo ""

    package_categories=$(gum choose --no-limit \
      "ğŸŸ¢ Essential (26 packages)" \
      "ğŸŸ¡ Development (4 packages)" \
      "ğŸŸ  Utilities (8 packages)" \
      "ğŸ”µ Optional (6 packages)")

    # Check if user actually selected anything
    if [[ -z "$package_categories" ]]; then
      log_warning "No package categories selected"
    fi
  fi
  echo ""

  # Node.js setup
  local install_node="false"
  if command -v node &> /dev/null; then
    gum style --foreground 246 "Node.js already installed: $(node --version)"
  elif echo "$package_categories" | grep -q "Development"; then
    if gum confirm "Install Node.js LTS via fnm?"; then
      install_node="true"
    fi
  fi
  echo ""

  # TMux plugins (only if tmux will be installed)
  local install_tpm="false"
  if [[ ! -d "$HOME/.tmux/plugins/tpm" ]]; then
    # Only offer tmux plugins if Essential category is selected (which includes tmux)
    if echo "$package_categories" | grep -q "Essential"; then
      if gum confirm "Install tmux plugins? (Installs TPM + all plugins automatically)"; then
        install_tpm="true"
      fi
    fi
  else
    gum style --foreground 246 "TPM already installed"
  fi
  echo ""

  # ============================================================================
  # SHOW COMPLETE PLAN
  # ============================================================================

  gum style \
    --border double \
    --padding "1 2" \
    --margin "1" \
    --border-foreground 212 \
    "ğŸ“‹ Installation Plan" \
    "" \
    "$(if [[ -n "$git_name" ]]; then echo "âœ“ Configure git: $git_name <$git_email>"; fi)" \
    "$(if [[ "$create_symlinks_choice" == "true" ]]; then echo "âœ“ Create dotfile symlinks (with safe backups)"; fi)" \
    "$(if [[ -n "$package_categories" ]]; then echo "âœ“ Install $(echo "$package_categories" | wc -l | tr -d ' ') package categories"; fi)" \
    "$(if [[ "$install_node" == "true" ]]; then echo "âœ“ Install Node.js LTS via fnm"; fi)" \
    "$(if [[ "$install_tpm" == "true" ]]; then echo "âœ“ Install tmux plugins (TPM + all plugins)"; fi)"

  echo ""

  if ! gum confirm "Execute this plan?"; then
    log_info "Bootstrap cancelled"
    exit 0
  fi

  # ============================================================================
  # EXECUTE EVERYTHING
  # ============================================================================

  echo ""
  gum style --foreground 212 --bold "ğŸš€ Executing..."
  echo ""

  # Git configuration
  if [[ -n "$git_name" ]]; then
    if [[ -f "$DOTFILES_DIR/git/gitconfig.symlink.example" ]]; then
      cp "$DOTFILES_DIR/git/gitconfig.symlink.example" "$DOTFILES_DIR/git/gitconfig.symlink"
      sed -i '' "s/AUTHORNAME/$git_name/g" "$DOTFILES_DIR/git/gitconfig.symlink"
      sed -i '' "s/AUTHOREMAIL/$git_email/g" "$DOTFILES_DIR/git/gitconfig.symlink"
      sed -i '' "s/GIT_CREDENTIAL_HELPER/osxkeychain/g" "$DOTFILES_DIR/git/gitconfig.symlink"
      log_info "Git configured for $git_name <$git_email>"
    fi
  fi

  # Symlinks
  if [[ "$create_symlinks_choice" == "true" ]]; then
    backup_existing_configs
    create_symlinks
  fi

  # Packages
  if [[ -n "$package_categories" ]]; then
    echo ""
    gum style --foreground 212 "ğŸ“¦ Installing selected packages..."
    echo "Categories: $package_categories" # Debug output
    echo ""

    # Build temp brewfile
    local temp_brewfile="/tmp/Brewfile.bootstrap"
    echo "# Temporary Brewfile for bootstrap" > "$temp_brewfile"
    echo "" >> "$temp_brewfile"

    grep "^tap " "$DOTFILES_DIR/Brewfile" >> "$temp_brewfile"
    echo "" >> "$temp_brewfile"

    if echo "$package_categories" | grep -q "Essential"; then
      sed -n '/^# ğŸŸ¢ ESSENTIAL/,/^# =/p' "$DOTFILES_DIR/Brewfile" | grep -v "^# =" >> "$temp_brewfile"
    fi
    if echo "$package_categories" | grep -q "Development"; then
      sed -n '/^# ğŸŸ¡ DEVELOPMENT/,/^# =/p' "$DOTFILES_DIR/Brewfile" | grep -v "^# =" >> "$temp_brewfile"
    fi
    if echo "$package_categories" | grep -q "Utilities"; then
      sed -n '/^# ğŸŸ  UTILITIES/,/^# =/p' "$DOTFILES_DIR/Brewfile" | grep -v "^# =" >> "$temp_brewfile"
    fi
    if echo "$package_categories" | grep -q "Optional"; then
      sed -n '/^# ğŸ”µ OPTIONAL/,/^$/p' "$DOTFILES_DIR/Brewfile" >> "$temp_brewfile"
    fi

    echo ""
    gum style --foreground 212 "Installing packages..."
    echo ""

    if brew bundle install --file="$temp_brewfile" 2>&1 | tee /tmp/brew-install.log; then
      rm "$temp_brewfile"
      echo ""
      log_info "âœ“ All packages installed successfully"
    else
      log_error "Package installation failed!"
      echo ""
      echo "Error output:"
      tail -20 /tmp/brew-install.log
      echo ""
      log_error "Installation stopped. Please fix the errors above and re-run bootstrap."
      exit 1
    fi
  fi

  # Additional setup
  setup_node "$install_node"

  # Only install tmux plugins if tmux is actually installed
  if [[ "$install_tpm" == "true" ]]; then
    if ! command -v tmux &> /dev/null; then
      log_error "Cannot install tmux plugins: tmux is not installed"
      echo "Please ensure the Essential package category was installed (includes tmux)"
      exit 1
    fi
    setup_tmux_plugins "$install_tpm"
  fi

  # Final summary
  echo ""
  echo ""
  gum style \
    --border double \
    --padding "1 2" \
    --margin "1" \
    --border-foreground 212 \
    "âœ“ Bootstrap Complete!" \
    "" \
    "What was installed:" \
    "$([ -n "$git_name" ] && echo "  âœ“ Git configured for $git_name" || echo "")" \
    "$([ "$create_symlinks_choice" == "true" ] && echo "  âœ“ Dotfiles symlinked" || echo "")" \
    "$([ -n "$package_categories" ] && echo "  âœ“ $(echo "$package_categories" | wc -w | tr -d ' ') package groups" || echo "")" \
    "$([ "$install_node" == "true" ] && echo "  âœ“ Node.js $(command -v node &>/dev/null && node --version || echo "ready")" || echo "")" \
    "$([ "$install_tpm" == "true" ] && echo "  âœ“ Tmux plugins installed" || echo "")" \
    "" \
    "Next steps:" \
    "1. Restart your shell: exec zsh" \
    "2. Launch neovim to install NvChad plugins" \
    "" \
    "Your fresh Mac is ready! ğŸ‰"

  echo ""
  echo ""
  gum style --foreground 212 --bold "âœ¨ Done! Enjoy your new setup. âœ¨"
  echo ""
}

main "$@"
