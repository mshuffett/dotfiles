#!/bin/bash
# ============================================================================
# One-Line Bootstrap Installer
# ============================================================================
# This script can be run directly from GitHub:
# curl -fsSL https://raw.githubusercontent.com/mshuffett/dotfiles/fresh-mac-magic/script/install_and_run_wizard | bash

set -e

echo "ðŸš€ Fresh Mac Bootstrap"
echo "====================="
echo ""

# Check if we're on macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
  echo "âŒ This script is designed for macOS"
  exit 1
fi

# Install Xcode Command Line Tools if needed
if ! xcode-select -p &> /dev/null; then
  echo "ðŸ“¦ Installing Xcode Command Line Tools..."
  xcode-select --install
  echo "â³ Please complete the Xcode CLT installation in the dialog,"
  echo "   then re-run this script."
  exit 0
fi

# Install Homebrew if needed
if ! command -v brew &> /dev/null; then
  echo "ðŸº Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # Add Homebrew to PATH for Apple Silicon Macs
  if [[ $(uname -m) == "arm64" ]]; then
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi
fi

# Clone dotfiles if not already present
if [[ ! -d "$HOME/.dotfiles" ]]; then
  echo "ðŸ“‚ Cloning dotfiles repository..."
  git clone https://github.com/mshuffett/dotfiles.git "$HOME/.dotfiles"
  cd "$HOME/.dotfiles"
  git checkout fresh-mac-magic
else
  echo "âœ“ Dotfiles already cloned"
  cd "$HOME/.dotfiles"

  # Offer to update
  echo "Update to latest version? (y/n)"
  read -r response
  if [[ "$response" =~ ^[Yy]$ ]]; then
    git pull origin fresh-mac-magic
  fi
fi

# Run the bootstrap wizard
echo ""
echo "ðŸŽ¨ Launching Bootstrap Wizard..."
echo ""
exec "$HOME/.dotfiles/script/bootstrap_wizard"
