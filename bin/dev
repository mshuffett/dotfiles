#!/bin/bash
# Connect to Fly.io dev server
#
# Usage:
#   dev           # SSH and attach to tmux session 'main'
#   dev -n        # SSH without tmux (new shell)
#   dev <cmd>     # Run a command on the server
#   dev stop      # Stop the server (save credits)
#   dev start     # Start the server
#   dev status    # Check server status
#   dev sync-creds # Manually sync Claude OAuth credentials

set -e

APP="dev-server"
MACHINE="e827400b0e42e8"
CREDS_SYNC_FILE="$HOME/.cache/dev-server-creds-sync"

# Sync Claude OAuth credentials to dev server
sync_creds() {
  local force="${1:-}"
  local now=$(date +%s)
  local last_sync=0

  if [[ -f "$CREDS_SYNC_FILE" ]]; then
    last_sync=$(cat "$CREDS_SYNC_FILE")
  fi

  local age=$((now - last_sync))

  # Sync if forced, never synced, or older than 30 minutes (1800 seconds)
  if [[ "$force" == "force" ]] || [[ $age -gt 1800 ]]; then
    echo "Syncing Claude credentials..."
    local creds=$(security find-generic-password -s "Claude Code-credentials" -w 2>/dev/null)
    if [[ -n "$creds" ]]; then
      # Write to temp file, copy via fly sftp, then clean up
      local tmpfile=$(mktemp)
      echo "$creds" > "$tmpfile"
      chmod 600 "$tmpfile"
      # Use a bash command that reads from a here-doc
      fly ssh console -a "$APP" -u michael -C "bash -c 'cat > ~/.claude/.credentials.json && chmod 600 ~/.claude/.credentials.json'" < "$tmpfile" 2>/dev/null
      rm -f "$tmpfile"
      echo "$now" > "$CREDS_SYNC_FILE"
      echo "Credentials synced."
    else
      echo "Warning: Could not read credentials from Keychain"
    fi
  fi
}

case "${1:-}" in
  stop)
    fly machine stop "$MACHINE" -a "$APP"
    echo "Server stopped"
    ;;
  start)
    fly machine start "$MACHINE" -a "$APP"
    echo "Server started"
    ;;
  status)
    fly machines list -a "$APP"
    ;;
  sync-creds)
    sync_creds force
    ;;
  -n|--no-tmux)
    sync_creds
    fly ssh console -a "$APP" -u michael --pty
    ;;
  "")
    # Default: SSH and attach to tmux (or create if doesn't exist)
    sync_creds
    fly ssh console -a "$APP" -u michael --pty -C "tmux new -A -s main"
    ;;
  *)
    # Run arbitrary command
    fly ssh console -a "$APP" -u michael -C "$*"
    ;;
esac
