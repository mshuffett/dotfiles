#!/bin/bash
set -e

# ============================================================================
# add-secret - Add a secret to ~/.env.zsh and back it up to 1Password
# ============================================================================
# Usage: add-secret KEY VALUE [--description "Optional description"]
#
# Examples:
#   add-secret OPENAI_API_KEY "sk-..."
#   add-secret GITHUB_TOKEN "ghp_..." --description "GitHub personal access token"
#
# What it does:
# 1. Adds or updates KEY=VALUE in ~/.env.zsh
# 2. Backs up to 1Password in the "Private" vault under "Shell Environment Variables"
# 3. Preserves formatting and comments in ~/.env.zsh

ENV_FILE="$HOME/.env.zsh"
OP_VAULT="Private"
OP_ITEM="Shell Environment Variables"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
  echo -e "${GREEN}✓${NC} $1"
}

log_error() {
  echo -e "${RED}✗${NC} $1"
}

log_warning() {
  echo -e "${YELLOW}⚠${NC} $1"
}

# Parse arguments
if [[ $# -lt 2 ]]; then
  echo "Usage: add-secret KEY VALUE [--description \"Optional description\"]"
  echo ""
  echo "Examples:"
  echo "  add-secret OPENAI_API_KEY \"sk-...\""
  echo "  add-secret GITHUB_TOKEN \"ghp_...\" --description \"GitHub personal access token\""
  exit 1
fi

KEY="$1"
VALUE="$2"
DESCRIPTION=""

# Parse optional description
shift 2
while [[ $# -gt 0 ]]; do
  case $1 in
    --description|-d)
      DESCRIPTION="$2"
      shift 2
      ;;
    *)
      log_error "Unknown option: $1"
      exit 1
      ;;
  esac
done

# Validate key format (alphanumeric and underscores)
if ! [[ "$KEY" =~ ^[A-Z_][A-Z0-9_]*$ ]]; then
  log_error "Invalid key format. Use UPPER_CASE_WITH_UNDERSCORES"
  exit 1
fi

# Check if 1Password CLI is available
if ! command -v op &> /dev/null; then
  log_error "1Password CLI not found. Install with: brew install 1password-cli"
  exit 1
fi

# Check if authenticated with 1Password
if ! op account list &> /dev/null; then
  log_warning "Not authenticated with 1Password. Signing in..."
  if ! op signin; then
    log_error "1Password authentication failed"
    exit 1
  fi
fi

# Create ~/.env.zsh if it doesn't exist
if [[ ! -f "$ENV_FILE" ]]; then
  cat > "$ENV_FILE" << 'EOF'
# ~/.env.zsh - Private environment variables (not in dotfiles repo)

# API Keys

EOF
  log_info "Created $ENV_FILE"
fi

# Check if key already exists in file
if grep -q "^export $KEY=" "$ENV_FILE"; then
  log_warning "Key $KEY already exists in $ENV_FILE, updating..."
  # Update existing key (preserves file structure)
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "s|^export $KEY=.*|export $KEY=\"$VALUE\"|" "$ENV_FILE"
  else
    sed -i "s|^export $KEY=.*|export $KEY=\"$VALUE\"|" "$ENV_FILE"
  fi
else
  # Add new key to end of file
  echo "export $KEY=\"$VALUE\"" >> "$ENV_FILE"
fi

log_info "Added $KEY to $ENV_FILE"

# Backup to 1Password
log_info "Backing up to 1Password..."

# Check if item exists in 1Password
if op item get "$OP_ITEM" --vault "$OP_VAULT" &> /dev/null; then
  # Item exists, update it
  # First, check if field exists
  if op item get "$OP_ITEM" --vault "$OP_VAULT" --fields "label=$KEY" &> /dev/null 2>&1; then
    # Field exists, edit it
    op item edit "$OP_ITEM" --vault "$OP_VAULT" "$KEY[password]=$VALUE" > /dev/null
    log_info "Updated $KEY in 1Password"
  else
    # Field doesn't exist, add it
    op item edit "$OP_ITEM" --vault "$OP_VAULT" "$KEY[password]=$VALUE" > /dev/null
    log_info "Added $KEY to 1Password"
  fi
else
  # Item doesn't exist, create it
  if [[ -n "$DESCRIPTION" ]]; then
    op item create \
      --category="Secure Note" \
      --title="$OP_ITEM" \
      --vault="$OP_VAULT" \
      "$KEY[password]=$VALUE" \
      --tags="shell,environment" \
      "notesPlain=$DESCRIPTION" > /dev/null
  else
    op item create \
      --category="Secure Note" \
      --title="$OP_ITEM" \
      --vault="$OP_VAULT" \
      "$KEY[password]=$VALUE" \
      --tags="shell,environment" > /dev/null
  fi
  log_info "Created 1Password item: $OP_ITEM"
fi

echo ""
log_info "Secret added successfully!"
echo ""
echo "To use in current shell: source ~/.env.zsh"
echo "To use in new shells: it will be loaded automatically"
