#!/bin/bash

# AI Image Generator
# Generates images using OpenAI or Google Gemini (nano-banana)

set -e

# Default values
SIZE="1024x1024"
OUTPUT=""
URL_ONLY=false
MODEL=""
PROVIDER="gemini"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Help function
show_help() {
    cat << EOF
AI Image Generator

Usage: generate-image "prompt" [options]

Options:
    -p, --provider PROVIDER  Provider to use: openai or gemini (default: gemini)
    -s, --size SIZE         Image size (default: 1024x1024)
                           Options: 1024x1024, 1024x1536, 1536x1024
    -o, --output FILE       Output filename (default: generated-image-TIMESTAMP.png)
    -u, --url-only         Only output the URL, don't download the image (OpenAI only)
    -m, --model MODEL      Model to use (default: dall-e-3 for OpenAI,
                           gemini-2.5-flash-image-preview for Gemini)
    -h, --help             Show this help message

Examples:
    generate-image "A sunset over mountains"
    generate-image "A red sports car" --provider openai
    generate-image "Abstract art" --output artwork.png
    generate-image "A cityscape" --provider openai --size 1024x1536
    generate-image "A cute robot"

Environment:
    GEMINI_API_KEY must be set for Gemini provider (default)
    OPENAI_API_KEY must be set for OpenAI provider

Providers:
    gemini - Google's Gemini 2.5 Flash Image (default)
    openai - OpenAI's DALL-E 3

EOF
}

# Parse arguments
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

# Check if first argument is help
if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    show_help
    exit 0
fi

PROMPT="$1"
shift

# Parse options
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -p|--provider)
            PROVIDER="$2"
            shift 2
            ;;
        -s|--size)
            SIZE="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT="$2"
            shift 2
            ;;
        -u|--url-only)
            URL_ONLY=true
            shift
            ;;
        -m|--model)
            MODEL="$2"
            shift 2
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            show_help
            exit 1
            ;;
    esac
done

# Validate provider
if [[ ! "$PROVIDER" =~ ^(openai|gemini)$ ]]; then
    echo -e "${RED}Error: Invalid provider. Must be 'openai' or 'gemini'${NC}"
    exit 1
fi

# Check for API keys and set defaults based on provider
if [ "$PROVIDER" = "openai" ]; then
    if [ -z "$OPENAI_API_KEY" ]; then
        echo -e "${RED}Error: OPENAI_API_KEY environment variable is not set${NC}"
        echo "Please set it with: export OPENAI_API_KEY='your-key-here'"
        exit 1
    fi
    # Set default model for OpenAI if not specified
    if [ -z "$MODEL" ]; then
        MODEL="dall-e-3"
    fi
elif [ "$PROVIDER" = "gemini" ]; then
    if [ -z "$GEMINI_API_KEY" ]; then
        echo -e "${RED}Error: GEMINI_API_KEY environment variable is not set${NC}"
        echo "Please set it with: export GEMINI_API_KEY='your-key-here'"
        exit 1
    fi
    # Set default model for Gemini if not specified
    if [ -z "$MODEL" ]; then
        MODEL="gemini-2.5-flash-image"
    fi
fi

# Validate size
if [[ ! "$SIZE" =~ ^(1024x1024|1024x1536|1536x1024)$ ]]; then
    echo -e "${RED}Error: Invalid size. Must be 1024x1024, 1024x1536, or 1536x1024${NC}"
    exit 1
fi

# Set output filename if not specified
if [ -z "$OUTPUT" ]; then
    OUTPUT="generated-image-$(date +%s).png"
fi

# Create temporary file for response
RESPONSE_FILE=$(mktemp)
trap "rm -f $RESPONSE_FILE" EXIT

# Make API request
echo -e "${YELLOW}Generating image with prompt: \"$PROMPT\"${NC}"
echo -e "${YELLOW}Provider: $PROVIDER, Size: $SIZE, Model: $MODEL${NC}"

if [ "$PROVIDER" = "openai" ]; then
    # OpenAI API request
    HTTP_CODE=$(curl -s -w "%{http_code}" -o "$RESPONSE_FILE" \
      --max-time 30 \
      -X POST https://api.openai.com/v1/images/generations \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer $OPENAI_API_KEY" \
      -d "{
        \"model\": \"$MODEL\",
        \"prompt\": \"$PROMPT\",
        \"n\": 1,
        \"size\": \"$SIZE\"
      }")
elif [ "$PROVIDER" = "gemini" ]; then
    # Create temporary JSON file for Gemini request
    REQUEST_FILE=$(mktemp)
    cat > "$REQUEST_FILE" << EOF
{
  "contents": [{
    "parts": [
      {"text": "$PROMPT"}
    ]
  }]
}
EOF

    # Gemini API request
    HTTP_CODE=$(curl -s -w "%{http_code}" -o "$RESPONSE_FILE" \
      --max-time 60 \
      -X POST "https://generativelanguage.googleapis.com/v1beta/models/$MODEL:generateContent" \
      -H "Content-Type: application/json" \
      -H "x-goog-api-key: $GEMINI_API_KEY" \
      -d @"$REQUEST_FILE")

    rm -f "$REQUEST_FILE"
fi

# Check HTTP status
if [ "$HTTP_CODE" -ne 200 ]; then
    echo -e "${RED}Error: API request failed with status $HTTP_CODE${NC}"
    echo "Response:"
    cat "$RESPONSE_FILE"
    exit 1
fi

# Check for API errors in response
if grep -q '"error"' "$RESPONSE_FILE"; then
    echo -e "${RED}API Error:${NC}"
    cat "$RESPONSE_FILE" | python3 -m json.tool 2>/dev/null || cat "$RESPONSE_FILE"
    exit 1
fi

# Extract URL or base64 data based on provider
if [ "$PROVIDER" = "openai" ]; then
    # OpenAI response handling
    if grep -q '"url"' "$RESPONSE_FILE"; then
        # URL response format
        IMAGE_URL=$(cat "$RESPONSE_FILE" | python3 -c "import json,sys; print(json.load(sys.stdin)['data'][0]['url'])")

        if [ "$URL_ONLY" = true ]; then
            echo "$IMAGE_URL"
        else
            echo -e "${YELLOW}Downloading image...${NC}"
            curl -s "$IMAGE_URL" -o "$OUTPUT"
            echo -e "${GREEN}✅ Image saved as: $OUTPUT${NC}"
        fi
    elif grep -q '"b64_json"' "$RESPONSE_FILE"; then
        # Base64 response format
        if [ "$URL_ONLY" = true ]; then
            echo -e "${YELLOW}Note: Image was returned as base64, not a URL${NC}"
        fi

        # Extract and save base64 image
        python3 -c "
import json
import base64
import sys

with open('$RESPONSE_FILE', 'r') as f:
    response = json.load(f)

base64_image = response['data'][0]['b64_json']
image_data = base64.b64decode(base64_image)

with open('$OUTPUT', 'wb') as img_file:
    img_file.write(image_data)
"
        echo -e "${GREEN}✅ Image saved as: $OUTPUT${NC}"
    else
        echo -e "${RED}Error: Unexpected response format${NC}"
        cat "$RESPONSE_FILE"
        exit 1
    fi
elif [ "$PROVIDER" = "gemini" ]; then
    # Gemini response handling
    if [ "$URL_ONLY" = true ]; then
        echo -e "${YELLOW}Note: Gemini returns base64 data, not URLs${NC}"
    fi

    # Extract and save base64 image from Gemini response
    python3 -c "
import json
import base64
import sys

try:
    with open('$RESPONSE_FILE', 'r') as f:
        response = json.load(f)

    # Gemini returns image in candidates[0].content.parts - find the part with inlineData
    parts = response['candidates'][0]['content']['parts']
    base64_image = None
    for part in parts:
        if 'inlineData' in part:
            base64_image = part['inlineData']['data']
            break

    if base64_image is None:
        raise KeyError('No inlineData found in response')

    image_data = base64.b64decode(base64_image)

    with open('$OUTPUT', 'wb') as img_file:
        img_file.write(image_data)
except (KeyError, IndexError) as e:
    print(f'Error extracting image from Gemini response: {e}', file=sys.stderr)
    with open('$RESPONSE_FILE', 'r') as f:
        print(f.read(), file=sys.stderr)
    sys.exit(1)
"
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✅ Image saved as: $OUTPUT${NC}"
    else
        echo -e "${RED}Error: Failed to extract image from Gemini response${NC}"
        exit 1
    fi
fi