#!/bin/bash
# Claude Continuous Runner
# Keeps Claude running continuously with periodic check-ins
# Based on validated testing: 12+ hours, 150+ check-ins, zero restarts

set -e

# Configuration
MODE="${1:-background}"  # "background" or "new-session"
SESSION_NAME="${2:-claude-continuous}"
WORK_DIR="${3:-$(pwd)}"
CHECK_INTERVAL="${4:-180}"  # 3 minutes default
LOG_FILE="$WORK_DIR/claude_continuous.log"

# Initialize log
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Check if tmux session exists
session_exists() {
    tmux has-session -t "$SESSION_NAME" 2>/dev/null
}

# Create and start Claude session
start_claude_session() {
    log "Starting Claude session: $SESSION_NAME"

    # Create tmux session
    tmux new-session -d -s "$SESSION_NAME" -c "$WORK_DIR"
    sleep 2

    # Get window number
    WINDOW_NUM=$(tmux list-windows -t "$SESSION_NAME" -F '#{window_index}' | head -1)
    log "Detected window number: $WINDOW_NUM"

    # Start Claude
    tmux send-keys -t "$SESSION_NAME:$WINDOW_NUM" "cd '$WORK_DIR'" Enter
    sleep 1
    tmux send-keys -t "$SESSION_NAME:$WINDOW_NUM" "claude" Enter
    sleep 5

    log "Claude session started successfully"
}

# Send periodic check-in
send_checkin() {
    local iteration=$1
    log "Sending check-in #$iteration"

    local window_num
    window_num=$(tmux list-windows -t "$SESSION_NAME" -F '#{window_index}' | head -1)

    tmux send-keys -t "$SESSION_NAME:$window_num" "Status check #$iteration: Continue working on current task." Enter
    log "Check-in #$iteration sent"
}

# Check health
check_health() {
    if ! session_exists; then
        log "ERROR: Session does not exist"
        return 1
    fi

    local window_num
    window_num=$(tmux list-windows -t "$SESSION_NAME" -F '#{window_index}' | head -1)

    local pane_pid
    pane_pid=$(tmux display-message -p -t "$SESSION_NAME:$window_num" '#{pane_pid}' 2>/dev/null)

    if [ -z "$pane_pid" ] || ! ps -p "$pane_pid" > /dev/null 2>&1; then
        log "ERROR: Pane process is dead"
        return 1
    fi

    log "Health check passed (PID: $pane_pid)"
    return 0
}

# Run in background mode (monitor current session)
run_background() {
    local iteration=0
    local start_time
    start_time=$(date +%s)

    # Detect current tmux session
    if [ -z "$TMUX" ]; then
        log "ERROR: Not running in tmux. Use 'new-session' mode instead."
        exit 1
    fi

    CURRENT_SESSION=$(tmux display-message -p '#{session_name}')
    CURRENT_WINDOW=$(tmux display-message -p '#{window_index}')

    log "===== Starting Continuous Runner (Background Mode) ====="
    log "Monitoring: $CURRENT_SESSION:$CURRENT_WINDOW"
    log "Check interval: ${CHECK_INTERVAL}s"
    log "Working directory: $WORK_DIR"
    log "======================================"

    while true; do
        iteration=$((iteration + 1))

        # Send self-check-in to current session
        log "Sending self-check-in #$iteration"

        # Calculate runtime
        local current_time
        current_time=$(date +%s)
        local runtime=$((current_time - start_time))
        local runtime_mins=$((runtime / 60))

        log "Runtime: ${runtime_mins} minutes | Iteration: $iteration"

        # Wait for next check-in
        sleep "$CHECK_INTERVAL"

        # This message will appear in this Claude session after sleep
        echo "â° Auto-check-in #$iteration (runtime: ${runtime_mins}m) - Continue working on current task."
    done
}

# Main monitoring loop (for new-session mode)
run_continuous() {
    local iteration=0
    local start_time
    start_time=$(date +%s)

    log "===== Starting Continuous Runner (New Session Mode) ====="
    log "Session: $SESSION_NAME"
    log "Check interval: ${CHECK_INTERVAL}s"
    log "Working directory: $WORK_DIR"
    log "======================================"

    while true; do
        iteration=$((iteration + 1))

        # Check if session exists
        if ! session_exists; then
            log "Session died, restarting..."
            start_claude_session
            log "Session restarted"
        fi

        # Health check
        if ! check_health; then
            log "Health check failed, recovering..."
            tmux kill-session -t "$SESSION_NAME" 2>/dev/null || true
            sleep 2
            start_claude_session
            log "Session recovered"
        fi

        # Send check-in
        send_checkin "$iteration"

        # Calculate runtime
        local current_time
        current_time=$(date +%s)
        local runtime=$((current_time - start_time))
        local runtime_mins=$((runtime / 60))

        log "Runtime: ${runtime_mins} minutes | Iteration: $iteration"

        # Wait for next check-in
        sleep "$CHECK_INTERVAL"
    done
}

# Cleanup
cleanup() {
    log "Cleaning up..."
    if session_exists; then
        tmux kill-session -t "$SESSION_NAME" 2>/dev/null || true
    fi
    log "Cleanup complete"
}

# Main execution
main() {
    local command="${5:-start}"

    case "$command" in
        start)
            if [ "$MODE" = "background" ]; then
                run_background
            else
                start_claude_session
                run_continuous
            fi
            ;;
        stop)
            if [ "$MODE" = "new-session" ]; then
                cleanup
            else
                echo "Background mode: Kill the background process manually"
                ps aux | grep "claude-continuous" | grep -v grep
            fi
            ;;
        status)
            if [ "$MODE" = "background" ]; then
                echo "Background mode status:"
                ps aux | grep "claude-continuous.*background" | grep -v grep || echo "Not running"
            else
                if session_exists; then
                    echo "Session $SESSION_NAME is running"
                    check_health
                    echo "Attach with: tmux attach -t $SESSION_NAME"
                else
                    echo "Session $SESSION_NAME is not running"
                fi
            fi
            ;;
        *)
            echo "Claude Continuous Runner"
            echo ""
            echo "Usage: $0 {background|new-session} [session_name] [work_dir] [interval] {start|stop|status}"
            echo ""
            echo "Modes:"
            echo "  background   - Run in current session (no new tmux session needed)"
            echo "  new-session  - Create new tmux session for Claude"
            echo ""
            echo "Arguments:"
            echo "  session_name - Name for tmux session (default: claude-continuous)"
            echo "  work_dir     - Working directory (default: current directory)"
            echo "  interval     - Seconds between check-ins (default: 180)"
            echo ""
            echo "Examples:"
            echo "  # Run in background (current session)"
            echo "  nohup $0 background \"\" \"\" 180 start > /dev/null 2>&1 &"
            echo ""
            echo "  # Create new session"
            echo "  $0 new-session my-task /path/to/project 180 start"
            echo ""
            echo "  # Check status"
            echo "  $0 background \"\" \"\" \"\" status"
            echo "  $0 new-session my-task /path/to/project 180 status"
            exit 1
            ;;
    esac
}

# Handle Ctrl+C for new-session mode only
if [ "$MODE" = "new-session" ]; then
    trap cleanup INT TERM
fi

main "$@"
