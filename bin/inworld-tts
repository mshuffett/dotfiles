#!/usr/bin/env node

/**
 * Inworld TTS CLI
 *
 * Usage:
 *   inworld-tts "Your text here"
 *   inworld-tts "Your text here" --voice Eve --output custom.mp3
 *   inworld-tts "Your text here" --voice Eve --model inworld-tts-max
 *
 * Options:
 *   --voice, -v      Voice ID (default: Eve)
 *   --model, -m      Model ID: inworld-tts-1 (default) or inworld-tts-max
 *   --output, -o     Output filename (default: output.mp3)
 *   --help, -h       Show this help message
 *
 * Available voices:
 *   Ashley, Bryson, Cassidy, Daria, Dylan, Emma, Ethan, Harper,
 *   Jackson, Jordan, Kelly, Liam, Madison, Mason, Morgan, Noah,
 *   Olivia, Riley, Samantha, Taylor
 */

import fs from 'fs';
import { parseArgs } from 'util';

// Parse command line arguments
const { values, positionals } = parseArgs({
  args: process.argv.slice(2),
  options: {
    voice: { type: 'string', short: 'v', default: 'Eve' },
    model: { type: 'string', short: 'm', default: 'inworld-tts-1' },
    output: { type: 'string', short: 'o', default: 'output.mp3' },
    help: { type: 'boolean', short: 'h', default: false },
  },
  allowPositionals: true,
});

// Show help
if (values.help) {
  console.log(`
Inworld TTS CLI

Usage:
  inworld-tts "Your text here"
  inworld-tts "Your text here" --voice Eve --output custom.mp3
  inworld-tts "Your text here" --voice Eve --model inworld-tts-max

Options:
  --voice, -v      Voice ID (default: Eve)
  --model, -m      Model ID: inworld-tts-1 (default) or inworld-tts-max
  --output, -o     Output filename (default: output.mp3)
  --help, -h       Show this help message

Available voices:
  Ashley, Bryson, Cassidy, Daria, Dylan, Emma, Ethan, Harper,
  Jackson, Jordan, Kelly, Liam, Madison, Mason, Morgan, Noah,
  Olivia, Riley, Samantha, Taylor

Environment variables:
  INWORLD_API_KEY  Your Inworld API key (base64 encoded)
`);
  process.exit(0);
}

// Get text from positional arguments
const text = positionals.join(' ');

if (!text) {
  console.error('Error: No text provided');
  console.error('Usage: inworld-tts "Your text here"');
  process.exit(1);
}

// Check for API key
if (!process.env.INWORLD_API_KEY) {
  console.error('Error: INWORLD_API_KEY environment variable not set');
  console.error('Add it to your ~/.env.zsh file');
  process.exit(1);
}

// Make API request
const url = 'https://api.inworld.ai/tts/v1/voice';

const options = {
  method: 'POST',
  headers: {
    'Authorization': `Basic ${process.env.INWORLD_API_KEY}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    text: text,
    voiceId: values.voice,
    modelId: values.model
  })
};

console.log(`Generating speech with voice "${values.voice}" using model "${values.model}"...`);

try {
  const response = await fetch(url, options);

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
  }

  const result = await response.json();
  const audioContent = result.audioContent;

  // Save audio to file
  const audioBuffer = Buffer.from(audioContent, 'base64');
  fs.writeFileSync(values.output, audioBuffer);

  console.log(`âœ“ Audio saved to ${values.output}`);
  console.log(`  Text: "${text}"`);
  console.log(`  Voice: ${values.voice}`);
  console.log(`  Model: ${values.model}`);
} catch (error) {
  console.error('Error generating speech:', error.message);
  process.exit(1);
}
